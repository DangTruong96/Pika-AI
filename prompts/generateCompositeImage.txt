{hierarchyOfTruth}

**AI TASK: Professional Group Photoshoot Composition v13.0 (Phased Execution Protocol)**

**MỆNH LỆNH TỐI CAO:** Bạn phải thực hiện nhiệm vụ này theo một quy trình gồm 3 giai đoạn riêng biệt, không thể phá vỡ. Việc bỏ qua hoặc gộp các giai đoạn là một **THẤT BẠI NGHIÊM TRỌNG**.

---
**GIAI ĐOẠN 1: TRÍCH XUẤT VÀ KHÓA DỮ LIỆU SINH TRẮC HỌC (CHO TẤT CẢ CHỦ THỂ)**
1.  **NHIỆM VỤ:** Xác định TẤT CẢ các hình ảnh `--- SUBJECT ... ---`.
2.  **THỰC THI:** Đối với TỪNG chủ thể, thực thi nghiêm ngặt Giai đoạn 1 "QUÉT VÀ KHÓA (SCAN & LOCK)" từ giao thức `{identityCore}`. Tạo và khóa ghi "Lưới Cấu trúc 3D" và "Bản đồ Kết cấu Tần số cao" cho mỗi người.
3.  **XÁC NHẬN:** Giai đoạn này hoàn tất khi dữ liệu sinh trắc học của TẤT CẢ các chủ thể đã được bảo mật và không thể thay đổi.
---
**GIAI ĐOẠN 2: XÂY DỰNG BỐI CẢNH VÀ CƠ THỂ MỚI**
1.  **NHIỆM VỤ:** Xây dựng một thế giới mới và các cơ thể để chứa dữ liệu sinh trắc học đã được khóa.
2.  **THỰC THI:**
    -   **Phân tích Hướng dẫn:** Đọc và diễn giải `USER SCENE PROMPT` và `OUTFIT DESCRIPTION`.
    -   **Thực thi Giao thức Đếm Chủ thể:** Tuân thủ "SUBJECT COUNT & MAPPING PROTOCOL" để đảm bảo đúng số lượng người và vai trò.
    -   **Tạo Tư thế & Trang phục:** Tạo các cơ thể mới với tư thế tương tác phù hợp và mặc trang phục được mô tả, tuân thủ `{bodyformAndSilhouetteIntegrity}`. Tại thời điểm này, đầu có thể là những ma-nơ-canh không có đặc điểm.
    -   **Tạo Bối cảnh:** Xây dựng môi trường, tuân thủ `{physicalInteractionEngine}` và `{forensicReconstructionEngine}` cho các vật thể.
    -   **Tích hợp Vật thể:** Nếu có hình ảnh `--- OBJECT ... ---`, thực thi `OBJECT INTEGRATION PROTOCOL`.
---
**GIAI ĐOẠN 3: TÁI CHIẾU, HỢP NHẤT VÀ KIỂM TOÁN**
1.  **NHIỆM VỤ:** Tích hợp dữ liệu sinh trắc học vào bối cảnh mới và hoàn thiện.
2.  **THỰC THI:**
    -   **Tái chiếu:** Đối với TỪNG chủ thể, thực thi Giai đoạn 2 "TÁI CHIẾU (RE-PROJECTION)" từ `{identityCore}`. Vứt bỏ đầu ma-nơ-canh và chiếu dữ liệu đã khóa tương ứng lên cơ thể.
    -   **Hợp nhất Ánh sáng & Phong cách:** Thực thi `{photorealisticLightingEngine}` và `{unificationEngine}` để đảm bảo tất cả các chủ thể hòa hợp hoàn hảo với môi trường và với nhau.
    -   **KIỂM TOÁN CUỐI CÙNG (BẮT BUỘC):** Đối với TỪNG chủ thể, thực thi Giai đoạn 3 "KIỂM TOÁN SINH TRẮC HỌC SAU KHI KẾT XUẤT" từ `{identityCore}`. Nếu bất kỳ khuôn mặt nào không đạt, hủy bỏ và làm lại.
---

**CÁC GIAO THỨC PHỤ TRỢ (Sub-Protocols):**
{identityCore}
{physicalInteractionEngine}
{unificationEngine}
{forensicReconstructionEngine}
{bodyformAndSilhouetteIntegrity}
{photorealisticLightingEngine}

**OBJECT INTEGRATION PROTOCOL v2.0 (ZERO-TOLERANCE FIDELITY MANDATE)**
-   **DIRECTIVE:** If you are provided with one or more images labeled "--- OBJECT X ---", you MUST execute this protocol.
-   **MANDATE:** The object is a "LOCKED ASSET". You are **STRICTLY FORBIDDEN** from altering its physical form, design, or color. The ONLY permitted modification is re-lighting it to match the scene. Integrate the **EXACT, UNMODIFIED** object into the scene, ensuring it interacts realistically with lighting and physics.

**SUBJECT COUNT & MAPPING PROTOCOL v2.0 (ZERO-TOLERANCE - NON-NEGOTIABLE):**
-   **(A) PRE-ANALYSIS:** Count the number of "--- SUBJECT X ---" labels (`N`). The final image **MUST** contain **EXACTLY `N`** people.
-   **(B) SUBJECT-ROLE MAPPING:** For each input subject, identify the person's role (e.g., man, woman, child) and map them to the corresponding role described in the `USER SCENE PROMPT` and `OUTFIT DESCRIPTION`.
-   **FAILURE CONDITION:** Generating an image with the wrong number of people, or with any person in the wrong pose/outfit for their identified role, is a complete task failure.

---
**USER SCENE PROMPT (Guideline):**
"{prompt}"
---
**OUTFIT DESCRIPTION (Guideline):**
"{outfitDescription}"
